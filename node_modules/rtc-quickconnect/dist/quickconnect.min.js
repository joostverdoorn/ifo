(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.quickconnect=f()}})(function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){(function(process){"use strict";var rtc=require("rtc-tools");var mbus=require("mbus");var cleanup=require("rtc-tools/cleanup");var detectPlugin=require("rtc-core/plugin");var debug=rtc.logger("rtc-quickconnect");var defaults=require("cog/defaults");var extend=require("cog/extend");var getable=require("cog/getable");var messenger=require("./messenger");var reTrailingSlash=/\/$/;module.exports=function(signalhost,opts){var hash=typeof location!="undefined"&&location.hash.slice(1);var signaller=require("rtc-signaller")(messenger(signalhost),opts);var ns=(opts||{}).ns||"";var room=(opts||{}).room;var debugging=(opts||{}).debug;var allowJoin=!(opts||{}).manualJoin;var heartbeat=(opts||{}).heartbeat||2500;var profile={};var announced=false;var iceServers;var localStreams=[];var calls=signaller.calls=getable({});var channels={};var plugins=signaller.plugins=(opts||{}).plugins||[];var plugin=detectPlugin(signaller.plugins);var pluginReady;var expectedLocalStreams=parseInt((opts||{}).expectedLocalStreams,10)||0;var announceTimer=0;var heartbeatTimer=0;var updateTimer=0;function callCreate(id,pc){calls.set(id,{active:false,pc:pc,channels:getable({}),streams:[],lastping:Date.now()})}function callEnd(id){var call=calls.get(id);if(!call){return}debug("ending call to: "+id);call.channels.keys().forEach(function(label){var channel=call.channels.get(label);var args=[id,channel,label];signaller.apply(signaller,["channel:closed"].concat(args));signaller.apply(signaller,["channel:closed:"+label].concat(args));channel.onopen=null});call.streams.forEach(function(stream){signaller("stream:removed",id,stream)});calls.delete(id);if(calls.keys().length===0){hbReset()}signaller("call:ended",id,call.pc);cleanup(call.pc)}function callStart(id,pc,data){var call=calls.get(id);var streams=[].concat(pc.getRemoteStreams());call.active=true;call.streams=[].concat(pc.getRemoteStreams());pc.onaddstream=createStreamAddHandler(id);pc.onremovestream=createStreamRemoveHandler(id);debug(signaller.id+" - "+id+" call start: "+streams.length+" streams");signaller("call:started",id,pc,data);hbInit();process.nextTick(function(){streams.forEach(receiveRemoteStream(id))})}function checkReadyToAnnounce(){clearTimeout(announceTimer);if(announced){return}if(!allowJoin){return}if(plugin&&!pluginReady){return}if(!iceServers){return}if(expectedLocalStreams&&localStreams.length<expectedLocalStreams){return}announceTimer=setTimeout(function(){var data=extend({room:room},profile);signaller.announce(data);announced=true},0)}function connect(id){var data=getPeerData(id);var pc;var monitor;if(data.room!==room){return}callEnd(id);pc=rtc.createConnection(extend({},opts,{iceServers:iceServers}),(opts||{}).constraints);signaller("peer:connect",data.id,pc,data);callCreate(data.id,pc);localStreams.forEach(function(stream,idx){pc.addStream(stream)});if(signaller.isMaster(data.id)){debug("is master, creating data channels: ",Object.keys(channels));Object.keys(channels).forEach(function(label){gotPeerChannel(pc.createDataChannel(label,channels[label]),pc,data)})}else{pc.ondatachannel=function(evt){var channel=evt&&evt.channel;if(!channel){return}if(channels[channel.label]!==undefined){gotPeerChannel(channel,pc,getPeerData(id))}}}debug("coupling "+signaller.id+" to "+data.id);monitor=rtc.couple(pc,id,signaller,extend({},opts,{logger:mbus("pc."+id,signaller)}));signaller("peer:couple",id,pc,data,monitor);monitor.once("connected",callStart.bind(null,id,pc,data));monitor.once("closed",callEnd.bind(null,id));if(signaller.isMaster(id)){monitor.createOffer()}}function createStreamAddHandler(id){return function(evt){debug("peer "+id+" added stream");updateRemoteStreams(id);receiveRemoteStream(id)(evt.stream)}}function createStreamRemoveHandler(id){return function(evt){debug("peer "+id+" removed stream");updateRemoteStreams(id);signaller("stream:removed",id,evt.stream)}}function getActiveCall(peerId){var call=calls.get(peerId);if(!call){throw new Error("No active call for peer: "+peerId)}return call}function getPeerData(id){var peer=signaller.peers.get(id);return peer&&peer.data}function gotPeerChannel(channel,pc,data){var channelMonitor;function channelReady(){var call=calls.get(data.id);var args=[data.id,channel,data,pc];debug('reporting channel "'+channel.label+'" ready, have call: '+!!call);clearInterval(channelMonitor);channel.onopen=null;if(call){call.channels.set(channel.label,channel)}debug("triggering channel:opened events for channel: "+channel.label);signaller.apply(signaller,["channel:opened"].concat(args));signaller.apply(signaller,["channel:opened:"+channel.label].concat(args))}debug("channel "+channel.label+" discovered for peer: "+data.id);if(channel.readyState==="open"){return channelReady()}debug("channel not ready, current state = "+channel.readyState);channel.onopen=channelReady;channelMonitor=setInterval(function(){debug("checking channel state, current state = "+channel.readyState);if(channel.readyState==="open"){channelReady()}},500)}function hbInit(){if(heartbeatTimer||!heartbeat){return}heartbeatTimer=setInterval(hbSend,heartbeat)}function hbSend(){var tickInactive=Date.now()-heartbeat*4;calls.keys().forEach(function(id){var call=calls.get(id);if(call.lastping<tickInactive){return callEnd(id)}signaller.to(id).send("/ping")})}function hbReset(){clearInterval(heartbeatTimer);heartbeatTimer=0}function initPlugin(){return plugin&&plugin.init(opts,function(err){if(err){return console.error("Could not initialize plugin: ",err)}pluginReady=true;checkReadyToAnnounce()})}function handleLocalAnnounce(data){if(data&&typeof data.room!="undefined"){room=data.room}}function handlePeerFilter(id,data){data.allow=data.allow&&localStreams.length>=expectedLocalStreams}function handlePeerUpdate(data){var id=data&&data.id;var activeCall=id&&calls.get(id);if(id&&!activeCall){debug("received peer update from peer "+id+", no active calls");signaller.to(id).send("/reconnect");return connect(id)}}function handlePing(sender){var call=calls.get(sender&&sender.id);if(call){call.lastping=Date.now()}}function receiveRemoteStream(id){var call=calls.get(id);return function(stream){signaller("stream:added",id,stream,getPeerData(id))}}function updateRemoteStreams(id){var call=calls.get(id);if(call&&call.pc){call.streams=[].concat(call.pc.getRemoteStreams())}}if(!room){if(typeof location!="undefined"&&!hash){hash=location.hash=""+Math.pow(2,53)*Math.random()}room=ns+"#"+hash}if(debugging){rtc.logger.enable.apply(rtc.logger,Array.isArray(debug)?debugging:["*"])}signaller.on("peer:announce",function(data){connect(data.id)});signaller.on("peer:update",handlePeerUpdate);signaller.on("message:reconnect",function(sender){connect(sender.id)});signaller.broadcast=signaller.addStream=function(stream){localStreams.push(stream);calls.values().forEach(function(data){data.pc.addStream(stream)});checkReadyToAnnounce();return signaller};signaller.endCalls=function(){calls.keys().forEach(callEnd)};signaller.close=function(){signaller.endCalls();signaller.leave()};signaller.createDataChannel=function(label,opts){calls.keys().forEach(function(peerId){var call=calls.get(peerId);var dc;if(call&&call.pc&&signaller.isMaster(peerId)){dc=call.pc.createDataChannel(label,opts);gotPeerChannel(dc,call.pc,getPeerData(peerId))}});channels[label]=opts||null;return signaller};signaller.join=function(){allowJoin=true;checkReadyToAnnounce()};signaller.get=function(name){return profile[name]};signaller.getLocalStreams=function(){return[].concat(localStreams)};signaller.reactive=function(){opts=opts||{};opts.reactive=true;return signaller};signaller.removeStream=function(stream){var localIndex=localStreams.indexOf(stream);calls.values().forEach(function(call){call.pc.removeStream(stream)});if(localIndex>=0){localStreams.splice(localIndex,1)}return signaller};signaller.requestChannel=function(targetId,label,callback){var call=getActiveCall(targetId);var channel=call&&call.channels.get(label);if(channel){callback(null,channel);return signaller}signaller.once("channel:opened:"+label,function(id,dc){callback(null,dc)});return signaller};signaller.requestStream=function(targetId,idx,callback){var call=getActiveCall(targetId);var stream;function waitForStream(peerId){if(peerId!==targetId){return}stream=call.pc.getRemoteStreams()[idx];if(stream){signaller.removeListener("stream:added",waitForStream);callback(null,stream)}}stream=call.pc.getRemoteStreams()[idx];if(stream){callback(null,stream);return signaller}signaller.on("stream:added",waitForStream);return signaller};signaller.profile=function(data){extend(profile,data);if(announced){clearTimeout(updateTimer);updateTimer=setTimeout(function(){signaller.announce(profile)},(opts||{}).updateDelay||1e3)}return signaller};signaller.waitForCall=function(targetId,callback){var call=calls.get(targetId);if(call&&call.active){callback(null,call.pc);return signaller}signaller.on("call:started",function handleNewCall(id){if(id===targetId){signaller.removeListener("call:started",handleNewCall);callback(null,calls.get(id).pc)}})};if(expectedLocalStreams){signaller.on("peer:filter",handlePeerFilter)}signaller.on("local:announce",handleLocalAnnounce);signaller.on("message:ping",handlePing);require("rtc-core/genice")(opts,function(err,servers){if(err){return console.error("could not find iceServers: ",err)}iceServers=servers;checkReadyToAnnounce()});if(plugin){initPlugin()}return signaller}}).call(this,require("_process"))},{"./messenger":2,_process:54,"cog/defaults":3,"cog/extend":4,"cog/getable":5,mbus:9,"rtc-core/genice":13,"rtc-core/plugin":15,"rtc-signaller":19,"rtc-tools":48,"rtc-tools/cleanup":44}],2:[function(require,module,exports){module.exports=function(messenger){if(typeof messenger=="function"){return messenger}return require("rtc-switchboard-messenger")(messenger)}},{"rtc-switchboard-messenger":35}],3:[function(require,module,exports){"use strict";module.exports=function(target){target=target||{};[].slice.call(arguments,1).forEach(function(source){if(!source){return}for(var prop in source){if(target[prop]===void 0){target[prop]=source[prop]}}});return target}},{}],4:[function(require,module,exports){"use strict";module.exports=function(target){[].slice.call(arguments,1).forEach(function(source){if(!source){return}for(var prop in source){target[prop]=source[prop]}});return target}},{}],5:[function(require,module,exports){module.exports=function(target){function get(key){return target[key]}function set(key,value){target[key]=value}function remove(key){return delete target[key]}function keys(){return Object.keys(target)}function values(){return Object.keys(target).map(function(key){return target[key]})}if(typeof target!="object"){return target}return{get:get,set:set,remove:remove,"delete":remove,keys:keys,values:values}}},{}],6:[function(require,module,exports){"use strict";module.exports=function(input){var isString=typeof input=="string"||input instanceof String;var reNumeric=/^\-?\d+\.?\d*$/;var shouldParse;var firstChar;var lastChar;if(!isString||input.length<2){if(isString&&reNumeric.test(input)){return parseFloat(input)}return input}if(input==="true"||input==="false"){return input==="true"}if(input==="null"){return null}firstChar=input.charAt(0);lastChar=input.charAt(input.length-1);shouldParse=firstChar=="{"&&lastChar=="}"||firstChar=="["&&lastChar=="]"||firstChar=='"'&&lastChar=='"';if(shouldParse){try{return JSON.parse(input)}catch(e){}}return reNumeric.test(input)?parseFloat(input):input}},{}],7:[function(require,module,exports){"use strict";var active=[];var unleashListeners=[];var targets=[console];var logger=module.exports=function(name){var enabled=checkActive();function checkActive(){return enabled=active.indexOf("*")>=0||active.indexOf(name)>=0}unleashListeners[unleashListeners.length]=checkActive;return function(){var args=[].slice.call(arguments);if(typeof args[0]=="string"||args[0]instanceof String){args[0]=name+": "+args[0]}if(!enabled){return}targets.forEach(function(target){target.log.apply(target,args)})}};logger.reset=function(){targets=[];active=[];return logger.enable()};logger.to=function(target){targets=targets.concat(target||[]);return logger};logger.enable=function(){active=active.concat([].slice.call(arguments));unleashListeners.forEach(function(listener){listener()});return logger}},{}],8:[function(require,module,exports){"use strict";module.exports=function(fn,delay,opts){var lastExec=(opts||{}).leading!==false?0:Date.now();var trailing=(opts||{}).trailing;var timer;var queuedArgs;var queuedScope;trailing=trailing||trailing===undefined;function invokeDefered(){fn.apply(queuedScope,queuedArgs||[]);lastExec=Date.now()}return function(){var tick=Date.now();var elapsed=tick-lastExec;clearTimeout(timer);if(elapsed<delay){queuedArgs=[].slice.call(arguments,0);queuedScope=this;return trailing&&(timer=setTimeout(invokeDefered,delay-elapsed))}lastExec=tick;fn.apply(this,arguments)}}},{}],9:[function(require,module,exports){var createTrie=require("array-trie");var reDelim=/[\.\:]/;var createBus=module.exports=function(namespace,parent,scope){var registry=createTrie();var feeds=[];function bus(name){var args=[].slice.call(arguments,1);var parts=getNameParts(name);var delimited=parts.join(".");var handlers=registry.get(parts)||[];var results;feeds.forEach(function(feed){feed({name:delimited,args:args})});results=[].concat(handlers).map(function(handler){return handler.apply(scope||this,args)});if(bus.parent){results=results.concat(bus.parent.apply(scope||this,[namespace.concat(parts)].concat(args)))}return results}function clear(name){if(name){registry.set(getNameParts(name),[])}else{registry=createTrie()}}function feed(handler){function stop(){feeds.splice(feeds.indexOf(handler),1)}feeds.push(handler);return stop}function getNameParts(name){return Array.isArray(name)?name:name?name.split(reDelim):[]}function off(name,handler){var handlers=registry.get(getNameParts(name));var idx=handlers?handlers.indexOf(handler):-1;if(idx>=0){handlers.splice(idx,1)}}function on(name,handler){var parts=getNameParts(name);var handlers=registry.get(parts);if(handlers){handlers.push(handler)}else{registry.set(parts,[handler])}return bus}function once(name,handler){return on(name,function handleEvent(){var result=handler.apply(this,arguments);bus.off(name,handleEvent);return result})}if(typeof namespace=="function"){parent=namespace;namespace=""}namespace=namespace&&namespace.split(reDelim)||[];bus.clear=bus.removeAllListeners=clear;bus.feed=feed;bus.on=bus.addListener=on;bus.once=once;bus.off=bus.removeListener=off;bus.parent=parent||namespace&&namespace.length>0&&createBus();return bus}},{"array-trie":11}],10:[function(require,module,exports){"use strict";function compileSearch(funcName,predicate,reversed,extraArgs,useNdarray,earlyOut){var code=["function ",funcName,"(a,l,h,",extraArgs.join(","),"){",earlyOut?"":"var i=",reversed?"l-1":"h+1",";while(l<=h){var m=(l+h)>>>1,x=a",useNdarray?".get(m)":"[m]"];if(earlyOut){if(predicate.indexOf("c")<0){code.push(";if(x===y){return m}else if(x<=y){")}else{code.push(";var p=c(x,y);if(p===0){return m}else if(p<=0){")}}else{code.push(";if(",predicate,"){i=m;")}if(reversed){code.push("l=m+1}else{h=m-1}")}else{code.push("h=m-1}else{l=m+1}")}code.push("}");if(earlyOut){code.push("return -1};")}else{code.push("return i};")}return code.join("")}function compileBoundsSearch(predicate,reversed,suffix,earlyOut){var result=new Function([compileSearch("A","x"+predicate+"y",reversed,["y"],false,earlyOut),compileSearch("B","x"+predicate+"y",reversed,["y"],true,earlyOut),compileSearch("P","c(x,y)"+predicate+"0",reversed,["y","c"],false,earlyOut),compileSearch("Q","c(x,y)"+predicate+"0",reversed,["y","c"],true,earlyOut),"function dispatchBsearch",suffix,"(a,y,c,l,h){if(a.shape){if(typeof(c)==='function'){return Q(a,(l===undefined)?0:l|0,(h===undefined)?a.shape[0]-1:h|0,y,c)}else{return B(a,(c===undefined)?0:c|0,(l===undefined)?a.shape[0]-1:l|0,y)}}else{if(typeof(c)==='function'){return P(a,(l===undefined)?0:l|0,(h===undefined)?a.length-1:h|0,y,c)}else{return A(a,(c===undefined)?0:c|0,(l===undefined)?a.length-1:l|0,y)}}}return dispatchBsearch",suffix].join(""));return result()}module.exports={ge:compileBoundsSearch(">=",false,"GE"),gt:compileBoundsSearch(">",false,"GT"),lt:compileBoundsSearch("<",true,"LT"),le:compileBoundsSearch("<=",true,"LE"),eq:compileBoundsSearch("-",true,"EQ",true)}},{}],11:[function(require,module,exports){"use strict";var bounds=require("binary-search-bounds");module.exports=createTrie;function Trie(symbols,children,value){this.symbols=symbols;this.children=children;this.value=value}var proto=Trie.prototype;proto.set=function(s,value){if(s.shape){var v=this;var n=s.shape[0];for(var i=0;i<n;++i){var c=s.get(i);var j=bounds.ge(v.symbols,c);if(j<v.symbols.length&&v.symbols[j]===c){v=v.children[j]}else{var l=new Trie([],[],value);for(var k=n-1;k>i;--k){l=new Trie([s.get(k)],[l])}v.symbols.splice(j,0,c);v.children.splice(j,0,l);return value}}return v.value=value}else{var v=this;var n=s.length;for(var i=0;i<n;++i){var c=s[i];var j=bounds.ge(v.symbols,c);if(j<v.symbols.length&&v.symbols[j]===c){v=v.children[j]}else{var l=new Trie([],[],value);for(var k=n-1;k>i;--k){l=new Trie([s[k]],[l])}v.symbols.splice(j,0,c);v.children.splice(j,0,l);return value}}return v.value=value}};proto.get=function(s){if(s.shape){var v=this;var n=s.shape[0];for(var i=0;i<n;++i){var c=s.get(i);var j=bounds.eq(v.symbols,c);if(j<0){return}v=v.children[j]}return v.value}else{var v=this;var n=s.length;for(var i=0;i<n;++i){var c=s[i];var j=bounds.eq(v.symbols,c);if(j<0){return}v=v.children[j]}return v.value}};function createTrie(){return new Trie([],[])}},{"binary-search-bounds":10}],12:[function(require,module,exports){"use strict";var browser=require("detect-browser");var detect=module.exports=function(target,opts){var attach=(opts||{}).attach;var prefixIdx;var prefix;var testName;var hostObject=this||(typeof window!="undefined"?window:undefined);var prefixes=((opts||{}).prefixes||["ms","o","moz","webkit"]).concat("");if(!hostObject){return}for(prefixIdx=prefixes.length;prefixIdx--;){prefix=prefixes[prefixIdx];testName=prefix+(prefix?target.charAt(0).toUpperCase()+target.slice(1):target);if(typeof hostObject[testName]!="undefined"){detect.browser=detect.browser||prefix.toLowerCase();if(attach){hostObject[target]=hostObject[testName]}return hostObject[testName]}}};detect.moz=typeof navigator!="undefined"&&!!navigator.mozGetUserMedia;detect.browser=browser.name;detect.browserVersion=detect.version=browser.version},{"detect-browser":14}],13:[function(require,module,exports){module.exports=function(opts,callback){var ice=(opts||{}).ice;var iceServers=(opts||{}).iceServers;if(typeof ice=="function"){return ice(opts,callback)}else if(Array.isArray(ice)){return callback(null,[].concat(ice))}callback(null,[].concat(iceServers||[]))}},{}],14:[function(require,module,exports){var browsers=[["chrome",/Chrom(?:e|ium)\/([0-9\.]+)(:?\s|$)/],["firefox",/Firefox\/([0-9\.]+)(?:\s|$)/],["opera",/Opera\/([0-9\.]+)(?:\s|$)/],["ie",/Trident\/7\.0.*rv\:([0-9\.]+)\).*Gecko$/],["ie",/MSIE\s([0-9\.]+);.*Trident\/[4-7].0/],["ie",/MSIE\s(7\.0)/],["bb10",/BB10;\sTouch.*Version\/([0-9\.]+)/],["android",/Android\s([0-9\.]+)/],["ios",/iPad\;\sCPU\sOS\s([0-9\._]+)/],["ios",/iPhone\;\sCPU\siPhone\sOS\s([0-9\._]+)/],["safari",/Safari\/([0-9\._]+)/]];var match=browsers.map(match).filter(isMatch)[0];var parts=match&&match[3].split(/[._]/).slice(0,3);while(parts&&parts.length<3){parts.push("0")}exports.name=match&&match[0];exports.version=parts&&parts.join(".");function match(pair){return pair.concat(pair[1].exec(navigator.userAgent))}function isMatch(pair){return!!pair[2]}},{}],15:[function(require,module,exports){var detect=require("./detect");var requiredFunctions=["init"];function isSupported(plugin){return plugin&&typeof plugin.supported=="function"&&plugin.supported(detect)}function isValid(plugin){var supportedFunctions=requiredFunctions.filter(function(fn){return typeof plugin[fn]=="function"});return supportedFunctions.length===requiredFunctions.length}module.exports=function(plugins){return[].concat(plugins||[]).filter(isSupported).filter(isValid)[0]}},{"./detect":12}],16:[function(require,module,exports){module.exports={dataEvent:"data",openEvent:"open",closeEvent:"close",errorEvent:"error",writeMethod:"write",closeMethod:"close",leaveTimeout:3e3}},{}],17:[function(require,module,exports){"use strict";var extend=require("cog/extend");module.exports=function(signaller){function dataAllowed(data){var cloned=extend({allow:true},data);signaller("peer:filter",data.id,cloned);return cloned.allow}return function(args,messageType,srcData,srcState,isDM){var data=args[0];var peer;if(data&&data.id&&data.id!==signaller.id){if(!dataAllowed(data)){return}peer=signaller.peers.get(data.id);signaller("peer:connected",data.id,data);if(peer&&!peer.inactive){extend(peer.data,data);return signaller("peer:update",data,srcData)}peer={id:data.id,roleIdx:[data.id,signaller.id].sort().indexOf(data.id),data:{}};extend(peer.data,data);clearTimeout(peer.leaveTimer);peer.inactive=false;signaller.peers.set(data.id,peer);if(signaller.autoreply&&!isDM){signaller.to(data.id).send("/announce",signaller.attributes)}return signaller("peer:announce",data,peer)}}}},{"cog/extend":4}],18:[function(require,module,exports){"use strict";module.exports=function(signaller,opts){return{announce:require("./announce")(signaller,opts)}}},{"./announce":17}],19:[function(require,module,exports){"use strict";var detect=require("rtc-core/detect");var defaults=require("cog/defaults");var extend=require("cog/extend");var mbus=require("mbus");var getable=require("cog/getable");var uuid=require("cuid");var pull=require("pull-stream");var pushable=require("pull-pushable");var RS_DISCONNECTED=0;var RS_CONNECTING=1;var RS_CONNECTED=2;var metadata={version:"5.2.2"};module.exports=function(messenger,opts){var autoreply=(opts||{}).autoreply;var autoconnect=(opts||{}).autoconnect;var reconnect=(opts||{}).reconnect;var localMeta={};var signaller=mbus("",(opts||{}).logger);var id=signaller.id=(opts||{}).id||uuid();var attributes=signaller.attributes={browser:detect.browser,browserVersion:detect.browserVersion,id:id,agent:"signaller@"+metadata.version};var peers=signaller.peers=getable({});var queue=require("pull-pushable")();var processor;var announceTimer=0;var readyState=RS_DISCONNECTED;function announceOnReconnect(){signaller.announce()}function bufferMessage(args){queue.push(createDataLine(args));if(readyState===RS_DISCONNECTED&&(autoconnect===undefined||autoconnect)){connect()}}function createDataLine(args){return args.map(prepareArg).join("|")}function createMetadata(){return extend({},localMeta,{id:signaller.id})}function handleDisconnect(){if(reconnect===undefined||reconnect){setTimeout(connect,50)}}function prepareArg(arg){if(typeof arg=="object"&&!(arg instanceof String)){return JSON.stringify(arg)}else if(typeof arg=="function"){return null}return arg}var connect=signaller.connect=function(){if(readyState===RS_CONNECTING){return}readyState=RS_CONNECTING;messenger(function(err,source,sink){if(err){readyState=RS_DISCONNECTED;return signaller("error",err)}readyState=RS_CONNECTED;pull(source,pull.through(null,function(){readyState=RS_DISCONNECTED;signaller("disconnected")}),pull.drain(processor));pull(queue,sink);signaller.removeListener("disconnected",handleDisconnect);signaller.on("disconnected",handleDisconnect);signaller("connected")})};var send=signaller.send=function(){var args=[].slice.call(arguments);args.splice(1,0,createMetadata());bufferMessage(args)};signaller.announce=function(data,sender){function sendAnnounce(){(sender||send)("/announce",attributes);signaller("local:announce",attributes)}if(readyState===RS_CONNECTED){signaller.removeListener("connected",announceOnReconnect);signaller.on("connected",announceOnReconnect)}clearTimeout(announceTimer);extend(attributes,data,{id:signaller.id});return announceTimer=setTimeout(sendAnnounce,(opts||{}).announceDelay||10)};signaller.isMaster=function(targetId){var peer=peers.get(targetId);return peer&&peer.roleIdx!==0};signaller.leave=signaller.close=function(){send("/leave",{id:id});signaller.removeListener("disconnected",handleDisconnect);signaller.removeListener("connected",announceOnReconnect);queue.end();queue=pushable();readyState=RS_DISCONNECTED};signaller.metadata=function(data){if(arguments.length===0){return extend({},localMeta)}localMeta=extend({},data)};signaller.to=function(targetId){var sender=function(){var peer=signaller.peers.get(targetId);var args;if(!peer){throw new Error("Unknown peer: "+targetId)}if(peer.inactive){return}args=["/to",targetId].concat([].slice.call(arguments));args.splice(3,0,createMetadata());bufferMessage(args)};return{announce:function(data){return signaller.announce(data,sender)},send:sender}};opts=defaults({},opts,require("./defaults"));signaller.autoreply=autoreply===undefined||autoreply;signaller.process=processor=require("./processor")(signaller,opts);if(autoconnect===undefined||autoconnect){connect()}return signaller}},{"./defaults":16,"./processor":34,"cog/defaults":3,"cog/extend":4,"cog/getable":5,cuid:20,mbus:9,"pull-pushable":21,"pull-stream":28,"rtc-core/detect":12}],20:[function(require,module,exports){(function(app){"use strict";var namespace="cuid",c=0,blockSize=4,base=36,discreteValues=Math.pow(base,blockSize),pad=function pad(num,size){var s="000000000"+num;return s.substr(s.length-size)},randomBlock=function randomBlock(){return pad((Math.random()*discreteValues<<0).toString(base),blockSize)},safeCounter=function(){c=c<discreteValues?c:0;c++;return c-1},api=function cuid(){var letter="c",timestamp=(new Date).getTime().toString(base),counter,fingerprint=api.fingerprint(),random=randomBlock()+randomBlock();counter=pad(safeCounter().toString(base),blockSize);return letter+timestamp+counter+fingerprint+random};api.slug=function slug(){var date=(new Date).getTime().toString(36),counter,print=api.fingerprint().slice(0,1)+api.fingerprint().slice(-1),random=randomBlock().slice(-2);counter=safeCounter().toString(36).slice(-4);return date.slice(-2)+counter+print+random};api.globalCount=function globalCount(){var cache=function calc(){var i,count=0;for(i in window){count++}return count}();api.globalCount=function(){return cache};return cache};api.fingerprint=function browserPrint(){return pad((navigator.mimeTypes.length+navigator.userAgent.length).toString(36)+api.globalCount().toString(36),4)};if(app.register){app.register(namespace,api)}else if(typeof module!=="undefined"){module.exports=api}else{app[namespace]=api}})(this.applitude||this)},{}],21:[function(require,module,exports){var pull=require("pull-stream");module.exports=pull.Source(function(onClose){var buffer=[],cbs=[],waiting=[],ended;function drain(){var l;while(waiting.length&&((l=buffer.length)||ended)){var data=buffer.shift();var cb=cbs.shift();waiting.shift()(l?null:ended,data);cb&&cb(ended===true?null:ended)}}function read(end,cb){ended=ended||end;waiting.push(cb);drain();if(ended)onClose&&onClose(ended===true?null:ended)}read.push=function(data,cb){if(ended)return cb&&cb(ended===true?null:ended);buffer.push(data);cbs.push(cb);drain()};read.end=function(end,cb){if("function"===typeof end)cb=end,end=true;ended=ended||end||true;if(cb)cbs.push(cb);drain();if(ended)onClose&&onClose(ended===true?null:ended)};return read})},{"pull-stream":22}],22:[function(require,module,exports){var sources=require("./sources");var sinks=require("./sinks");var throughs=require("./throughs");var u=require("pull-core");for(var k in sources)exports[k]=u.Source(sources[k]);for(var k in throughs)exports[k]=u.Through(throughs[k]);for(var k in sinks)exports[k]=u.Sink(sinks[k]);var maybe=require("./maybe")(exports);for(var k in maybe)exports[k]=maybe[k];exports.Duplex=exports.Through=exports.pipeable=u.Through;exports.Source=exports.pipeableSource=u.Source;exports.Sink=exports.pipeableSink=u.Sink},{"./maybe":23,"./sinks":25,"./sources":26,"./throughs":27,"pull-core":24}],23:[function(require,module,exports){var u=require("pull-core");var prop=u.prop;var id=u.id;var maybeSink=u.maybeSink;module.exports=function(pull){var exports={};var drain=pull.drain;var find=exports.find=function(test,cb){return maybeSink(function(cb){var ended=false;if(!cb)cb=test,test=id;else test=prop(test)||id;return drain(function(data){if(test(data)){ended=true;cb(null,data);return false}},function(err){if(ended)return;cb(err===true?null:err,null)})},cb)};var reduce=exports.reduce=function(reduce,acc,cb){return maybeSink(function(cb){return drain(function(data){acc=reduce(acc,data)},function(err){cb(err,acc)})},cb)};var collect=exports.collect=exports.writeArray=function(cb){return reduce(function(arr,item){arr.push(item);return arr},[],cb)};return exports}},{"pull-core":24}],24:[function(require,module,exports){exports.id=function(item){return item};exports.prop=function(map){if("string"==typeof map){var key=map;return function(data){return data[key]}}return map};exports.tester=function(test){if(!test)return exports.id;if("object"===typeof test&&"function"===typeof test.test)return test.test.bind(test);return exports.prop(test)||exports.id};exports.addPipe=addPipe;function addPipe(read){if("function"!==typeof read)return read;read.pipe=read.pipe||function(reader){if("function"!=typeof reader)throw new Error("must pipe to reader");return addPipe(reader(read))};read.type="Source";return read}var Source=exports.Source=function Source(createRead){function s(){var args=[].slice.call(arguments);return addPipe(createRead.apply(null,args))}s.type="Source";return s};var Through=exports.Through=function(createRead){return function(){var args=[].slice.call(arguments);var piped=[];function reader(read){args.unshift(read);read=createRead.apply(null,args);while(piped.length)read=piped.shift()(read);return read}reader.pipe=function(read){piped.push(read);if(read.type==="Source")throw new Error("cannot pipe "+reader.type+" to Source");reader.type=read.type==="Sink"?"Sink":"Through";return reader};reader.type="Through";return reader}};var Sink=exports.Sink=function Sink(createReader){return function(){var args=[].slice.call(arguments);if(!createReader)throw new Error("must be createReader function");function s(read){args.unshift(read);return createReader.apply(null,args)}s.type="Sink";return s}};exports.maybeSink=exports.maybeDrain=function(createSink,cb){if(!cb)return Through(function(read){var ended;return function(close,cb){if(close)return read(close,cb);if(ended)return cb(ended);createSink(function(err,data){ended=err||true;if(!err)cb(null,data);else cb(ended)})(read)}})();return Sink(function(read){return createSink(cb)(read)})()}},{}],25:[function(require,module,exports){var drain=exports.drain=function(read,op,done){(function next(){var loop=true,cbed=false;while(loop){cbed=false;read(null,function(end,data){cbed=true;if(end){loop=false;done&&done(end===true?null:end)}else if(op&&false===op(data)){loop=false;read(true,done||function(){})}else if(!loop){next()}});if(!cbed){loop=false;return}}})()};var onEnd=exports.onEnd=function(read,done){return drain(read,null,done)};var log=exports.log=function(read,done){return drain(read,function(data){console.log(data)
},done)}},{}],26:[function(require,module,exports){var keys=exports.keys=function(object){return values(Object.keys(object))};var once=exports.once=function(value){return function(abort,cb){if(abort)return cb(abort);if(value!=null){var _value=value;value=null;cb(null,_value)}else cb(true)}};var values=exports.values=exports.readArray=function(array){if(!Array.isArray(array))array=Object.keys(array).map(function(k){return array[k]});var i=0;return function(end,cb){if(end)return cb&&cb(end);cb(i>=array.length||null,array[i++])}};var count=exports.count=function(max){var i=0;max=max||Infinity;return function(end,cb){if(end)return cb&&cb(end);if(i>max)return cb(true);cb(null,i++)}};var infinite=exports.infinite=function(generate){generate=generate||Math.random;return function(end,cb){if(end)return cb&&cb(end);return cb(null,generate())}};var defer=exports.defer=function(){var _read,cbs=[],_end;var read=function(end,cb){if(!_read){_end=end;cbs.push(cb)}else _read(end,cb)};read.resolve=function(read){if(_read)throw new Error("already resolved");_read=read;if(!_read)throw new Error("no read cannot resolve!"+_read);while(cbs.length)_read(_end,cbs.shift())};read.abort=function(err){read.resolve(function(_,cb){cb(err||true)})};return read};var empty=exports.empty=function(){return function(abort,cb){cb(true)}};var depthFirst=exports.depthFirst=function(start,createStream){var reads=[];reads.unshift(once(start));return function next(end,cb){if(!reads.length)return cb(true);reads[0](end,function(end,data){if(end){reads.shift();return next(null,cb)}reads.unshift(createStream(data));cb(end,data)})}};var widthFirst=exports.widthFirst=function(start,createStream){var reads=[];reads.push(once(start));return function next(end,cb){if(!reads.length)return cb(true);reads[0](end,function(end,data){if(end){reads.shift();return next(null,cb)}reads.push(createStream(data));cb(end,data)})}};var leafFirst=exports.leafFirst=function(start,createStream){var reads=[];var output=[];reads.push(once(start));return function next(end,cb){reads[0](end,function(end,data){if(end){reads.shift();if(!output.length)return cb(true);return cb(null,output.shift())}reads.unshift(createStream(data));output.unshift(data);next(null,cb)})}}},{}],27:[function(require,module,exports){(function(process){var u=require("pull-core");var sources=require("./sources");var sinks=require("./sinks");var prop=u.prop;var id=u.id;var tester=u.tester;var map=exports.map=function(read,map){map=prop(map)||id;return function(end,cb){read(end,function(end,data){var data=!end?map(data):null;cb(end,data)})}};var asyncMap=exports.asyncMap=function(read,map){if(!map)return read;return function(end,cb){if(end)return read(end,cb);read(null,function(end,data){if(end)return cb(end,data);map(data,cb)})}};var paraMap=exports.paraMap=function(read,map,width){if(!map)return read;var ended=false,queue=[],_cb;function drain(){if(!_cb)return;var cb=_cb;_cb=null;if(queue.length)return cb(null,queue.shift());else if(ended&&!n)return cb(ended);_cb=cb}function pull(){read(null,function(end,data){if(end){ended=end;return drain()}n++;map(data,function(err,data){n--;queue.push(data);drain()});if(n<width&&!ended)pull()})}var n=0;return function(end,cb){if(end)return read(end,cb);_cb=cb;if(queue.length||ended)pull(),drain();else pull()};return highWaterMark(asyncMap(read,map),width)};var filter=exports.filter=function(read,test){test=tester(test);return function next(end,cb){read(end,function(end,data){if(!end&&!test(data))return next(end,cb);cb(end,data)})}};var filterNot=exports.filterNot=function(read,test){test=tester(test);return filter(read,function(e){return!test(e)})};var through=exports.through=function(read,op,onEnd){var a=false;function once(abort){if(a||!onEnd)return;a=true;onEnd(abort===true?null:abort)}return function(end,cb){if(end)once(end);return read(end,function(end,data){if(!end)op&&op(data);else once(end);cb(end,data)})}};var take=exports.take=function(read,test){var ended=false;if("number"===typeof test){var n=test;test=function(){return n--}}return function(end,cb){if(ended)return cb(ended);if(ended=end)return read(ended,cb);read(null,function(end,data){if(ended=ended||end)return cb(ended);if(!test(data)){ended=true;read(true,function(end,data){cb(ended,data)})}else cb(null,data)})}};var unique=exports.unique=function(read,field,invert){field=prop(field)||id;var seen={};return filter(read,function(data){var key=field(data);if(seen[key])return!!invert;else seen[key]=true;return!invert})};var nonUnique=exports.nonUnique=function(read,field){return unique(read,field,true)};var group=exports.group=function(read,size){var ended;size=size||5;var queue=[];return function(end,cb){if(end)return read(ended=end,cb);if(ended)return cb(ended);read(null,function next(end,data){if(ended=ended||end){if(!queue.length)return cb(ended);var _queue=queue;queue=[];return cb(null,_queue)}queue.push(data);if(queue.length<size)return read(null,next);var _queue=queue;queue=[];cb(null,_queue)})}};var flatten=exports.flatten=function(read){var _read;return function(abort,cb){if(_read)nextChunk();else nextStream();function nextChunk(){_read(null,function(end,data){if(end)nextStream();else cb(null,data)})}function nextStream(){read(null,function(end,stream){if(end)return cb(end);if(Array.isArray(stream))stream=sources.values(stream);else if("function"!=typeof stream)throw new Error("expected stream of streams");_read=stream;nextChunk()})}}};var prepend=exports.prepend=function(read,head){return function(abort,cb){if(head!==null){if(abort)return read(abort,cb);var _head=head;head=null;cb(null,_head)}else{read(abort,cb)}}};var _reduce=exports._reduce=function(read,reduce,initial){return function(close,cb){if(close)return read(close,cb);if(ended)return cb(ended);sinks.drain(function(item){initial=reduce(initial,item)},function(err,data){ended=err||true;if(!err)cb(null,initial);else cb(ended)})(read)}};var nextTick=process.nextTick;var highWaterMark=exports.highWaterMark=function(read,highWaterMark){var buffer=[],waiting=[],ended,reading=false;highWaterMark=highWaterMark||10;function readAhead(){while(waiting.length&&(buffer.length||ended))waiting.shift()(ended,ended?null:buffer.shift())}function next(){if(ended||reading||buffer.length>=highWaterMark)return;reading=true;return read(ended,function(end,data){reading=false;ended=ended||end;if(data!=null)buffer.push(data);next();readAhead()})}nextTick(next);return function(end,cb){ended=ended||end;waiting.push(cb);next();readAhead()}}}).call(this,require("_process"))},{"./sinks":25,"./sources":26,_process:54,"pull-core":24}],28:[function(require,module,exports){var sources=require("./sources");var sinks=require("./sinks");var throughs=require("./throughs");var u=require("pull-core");function isFunction(fun){return"function"===typeof fun}function isReader(fun){return fun&&(fun.type==="Through"||fun.length===1)}var exports=module.exports=function pull(){var args=[].slice.call(arguments);if(isReader(args[0]))return function(read){args.unshift(read);return pull.apply(null,args)};var read=args.shift();if(isFunction(read.source))read=read.source;function next(){var s=args.shift();if(null==s)return next();if(isFunction(s))return s;return function(read){s.sink(read);return s.source}}while(args.length)read=next()(read);return read};for(var k in sources)exports[k]=u.Source(sources[k]);for(var k in throughs)exports[k]=u.Through(throughs[k]);for(var k in sinks)exports[k]=u.Sink(sinks[k]);var maybe=require("./maybe")(exports);for(var k in maybe)exports[k]=maybe[k];exports.Duplex=exports.Through=exports.pipeable=u.Through;exports.Source=exports.pipeableSource=u.Source;exports.Sink=exports.pipeableSink=u.Sink},{"./maybe":29,"./sinks":31,"./sources":32,"./throughs":33,"pull-core":30}],29:[function(require,module,exports){var u=require("pull-core");var prop=u.prop;var id=u.id;var maybeSink=u.maybeSink;module.exports=function(pull){var exports={};var drain=pull.drain;var find=exports.find=function(test,cb){return maybeSink(function(cb){var ended=false;if(!cb)cb=test,test=id;else test=prop(test)||id;return drain(function(data){if(test(data)){ended=true;cb(null,data);return false}},function(err){if(ended)return;cb(err===true?null:err,null)})},cb)};var reduce=exports.reduce=function(reduce,acc,cb){return maybeSink(function(cb){return drain(function(data){acc=reduce(acc,data)},function(err){cb(err,acc)})},cb)};var collect=exports.collect=exports.writeArray=function(cb){return reduce(function(arr,item){arr.push(item);return arr},[],cb)};var concat=exports.concat=function(cb){return reduce(function(a,b){return a+b},"",cb)};return exports}},{"pull-core":30}],30:[function(require,module,exports){arguments[4][24][0].apply(exports,arguments)},{dup:24}],31:[function(require,module,exports){var drain=exports.drain=function(read,op,done){(function next(){var loop=true,cbed=false;while(loop){cbed=false;read(null,function(end,data){cbed=true;if(end){loop=false;if(done)done(end===true?null:end);else if(end&&end!==true)throw end}else if(op&&false===op(data)){loop=false;read(true,done||function(){})}else if(!loop){next()}});if(!cbed){loop=false;return}}})()};var onEnd=exports.onEnd=function(read,done){return drain(read,null,done)};var log=exports.log=function(read,done){return drain(read,function(data){console.log(data)},done)}},{}],32:[function(require,module,exports){var keys=exports.keys=function(object){return values(Object.keys(object))};var once=exports.once=function(value){return function(abort,cb){if(abort)return cb(abort);if(value!=null){var _value=value;value=null;cb(null,_value)}else cb(true)}};var values=exports.values=exports.readArray=function(array){if(!Array.isArray(array))array=Object.keys(array).map(function(k){return array[k]});var i=0;return function(end,cb){if(end)return cb&&cb(end);cb(i>=array.length||null,array[i++])}};var count=exports.count=function(max){var i=0;max=max||Infinity;return function(end,cb){if(end)return cb&&cb(end);if(i>max)return cb(true);cb(null,i++)}};var infinite=exports.infinite=function(generate){generate=generate||Math.random;return function(end,cb){if(end)return cb&&cb(end);return cb(null,generate())}};var defer=exports.defer=function(){var _read,cbs=[],_end;var read=function(end,cb){if(!_read){_end=end;cbs.push(cb)}else _read(end,cb)};read.resolve=function(read){if(_read)throw new Error("already resolved");_read=read;if(!_read)throw new Error("no read cannot resolve!"+_read);while(cbs.length)_read(_end,cbs.shift())};read.abort=function(err){read.resolve(function(_,cb){cb(err||true)})};return read};var empty=exports.empty=function(){return function(abort,cb){cb(true)}};var error=exports.error=function(err){return function(abort,cb){cb(err)}};var depthFirst=exports.depthFirst=function(start,createStream){var reads=[];reads.unshift(once(start));return function next(end,cb){if(!reads.length)return cb(true);reads[0](end,function(end,data){if(end){reads.shift();return next(null,cb)}reads.unshift(createStream(data));cb(end,data)})}};var widthFirst=exports.widthFirst=function(start,createStream){var reads=[];reads.push(once(start));return function next(end,cb){if(!reads.length)return cb(true);reads[0](end,function(end,data){if(end){reads.shift();return next(null,cb)}reads.push(createStream(data));cb(end,data)})}};var leafFirst=exports.leafFirst=function(start,createStream){var reads=[];var output=[];reads.push(once(start));return function next(end,cb){reads[0](end,function(end,data){if(end){reads.shift();if(!output.length)return cb(true);return cb(null,output.shift())}reads.unshift(createStream(data));output.unshift(data);next(null,cb)})}}},{}],33:[function(require,module,exports){(function(process){var u=require("pull-core");var sources=require("./sources");var sinks=require("./sinks");var prop=u.prop;var id=u.id;var tester=u.tester;var map=exports.map=function(read,map){map=prop(map)||id;return function(abort,cb){read(abort,function(end,data){try{data=!end?map(data):null}catch(err){return read(err,function(){return cb(err)})}cb(end,data)})}};var asyncMap=exports.asyncMap=function(read,map){if(!map)return read;return function(end,cb){if(end)return read(end,cb);read(null,function(end,data){if(end)return cb(end,data);map(data,cb)})}};var paraMap=exports.paraMap=function(read,map,width){if(!map)return read;var ended=false,queue=[],_cb;function drain(){if(!_cb)return;var cb=_cb;_cb=null;if(queue.length)return cb(null,queue.shift());else if(ended&&!n)return cb(ended);_cb=cb}function pull(){read(null,function(end,data){if(end){ended=end;return drain()}n++;map(data,function(err,data){n--;queue.push(data);drain()});if(n<width&&!ended)pull()})}var n=0;return function(end,cb){if(end)return read(end,cb);_cb=cb;if(queue.length||ended)pull(),drain();else pull()};return highWaterMark(asyncMap(read,map),width)};var filter=exports.filter=function(read,test){test=tester(test);return function next(end,cb){var sync,loop=true;while(loop){loop=false;sync=true;read(end,function(end,data){if(!end&&!test(data))return sync?loop=true:next(end,cb);cb(end,data)});sync=false}}};var filterNot=exports.filterNot=function(read,test){test=tester(test);return filter(read,function(e){return!test(e)})};var through=exports.through=function(read,op,onEnd){var a=false;function once(abort){if(a||!onEnd)return;a=true;onEnd(abort===true?null:abort)}return function(end,cb){if(end)once(end);return read(end,function(end,data){if(!end)op&&op(data);else once(end);cb(end,data)})}};var take=exports.take=function(read,test){var ended=false;if("number"===typeof test){var n=test;test=function(){return n--}}return function(end,cb){if(ended)return cb(ended);if(ended=end)return read(ended,cb);read(null,function(end,data){if(ended=ended||end)return cb(ended);if(!test(data)){ended=true;read(true,function(end,data){cb(ended,data)})}else cb(null,data)})}};var unique=exports.unique=function(read,field,invert){field=prop(field)||id;var seen={};return filter(read,function(data){var key=field(data);if(seen[key])return!!invert;else seen[key]=true;return!invert})};var nonUnique=exports.nonUnique=function(read,field){return unique(read,field,true)};var group=exports.group=function(read,size){var ended;size=size||5;var queue=[];return function(end,cb){if(end)return read(ended=end,cb);if(ended)return cb(ended);read(null,function next(end,data){if(ended=ended||end){if(!queue.length)return cb(ended);var _queue=queue;queue=[];return cb(null,_queue)}queue.push(data);if(queue.length<size)return read(null,next);var _queue=queue;queue=[];cb(null,_queue)})}};var flatten=exports.flatten=function(read){var _read;return function(abort,cb){if(_read)nextChunk();else nextStream();function nextChunk(){_read(null,function(end,data){if(end)nextStream();else cb(null,data)})}function nextStream(){read(null,function(end,stream){if(end)return cb(end);if(Array.isArray(stream)||stream&&"object"===typeof stream)stream=sources.values(stream);else if("function"!=typeof stream)throw new Error("expected stream of streams");_read=stream;nextChunk()})}}};var prepend=exports.prepend=function(read,head){return function(abort,cb){if(head!==null){if(abort)return read(abort,cb);var _head=head;head=null;cb(null,_head)}else{read(abort,cb)}}};var _reduce=exports._reduce=function(read,reduce,initial){return function(close,cb){if(close)return read(close,cb);if(ended)return cb(ended);sinks.drain(function(item){initial=reduce(initial,item)},function(err,data){ended=err||true;if(!err)cb(null,initial);else cb(ended)})(read)}};var nextTick=process.nextTick;var highWaterMark=exports.highWaterMark=function(read,highWaterMark){var buffer=[],waiting=[],ended,ending,reading=false;highWaterMark=highWaterMark||10;function readAhead(){while(waiting.length&&(buffer.length||ended))waiting.shift()(ended,ended?null:buffer.shift());if(!buffer.length&&ending)ended=ending}function next(){if(ended||ending||reading||buffer.length>=highWaterMark)return;reading=true;return read(ended||ending,function(end,data){reading=false;ending=ending||end;if(data!=null)buffer.push(data);next();readAhead()})}process.nextTick(next);return function(end,cb){ended=ended||end;waiting.push(cb);next();readAhead()}};var flatMap=exports.flatMap=function(read,mapper){mapper=mapper||id;var queue=[],ended;return function(abort,cb){if(queue.length)return cb(null,queue.shift());else if(ended)return cb(ended);read(abort,function next(end,data){if(end)ended=end;else{var add=mapper(data);while(add&&add.length)queue.push(add.shift())}if(queue.length)cb(null,queue.shift());else if(ended)cb(ended);else read(null,next)})}}}).call(this,require("_process"))},{"./sinks":31,"./sources":32,_process:54,"pull-core":30}],34:[function(require,module,exports){"use strict";var jsonparse=require("cog/jsonparse");module.exports=function(signaller,opts){var handlers=require("./handlers")(signaller,opts);function sendEvent(parts,srcState,data){var evtName="message:"+parts[0].slice(1);var args=parts.slice(2).map(jsonparse);signaller.apply(signaller,[evtName].concat(args).concat([srcState,data]))}return function(originalData){var data=originalData;var isMatch=true;var parts;var handler;var srcData;var srcState;var isDirectMessage=false;if(data&&data.slice(0,6)==="primus"){return}var id=signaller.id+"";if(data.slice(0,3)==="/to"){isMatch=data.slice(4,id.length+4)===id;if(isMatch){parts=data.slice(5+id.length).split("|").map(jsonparse);isDirectMessage=true;parts=parts.map(jsonparse)}}if(!isMatch){return}signaller("rawdata",data);parts=parts||data.split("|").map(jsonparse);if(typeof parts[0]=="string"){srcData=parts[1];if(srcData&&srcData.id===signaller.id){return console.warn("got data from ourself, discarding")}srcState=signaller.peers.get(srcData&&srcData.id)||srcData;if(parts[0].charAt(0)==="/"){handler=handlers[parts[0].slice(1)];if(typeof handler=="function"){handler(parts.slice(2),parts[0].slice(1),srcData,srcState,isDirectMessage)}else{sendEvent(parts,srcState,originalData)}}else{signaller("data",parts.slice(0,1).concat(parts.slice(2)),srcData,srcState,isDirectMessage)}}}}},{"./handlers":18,"cog/jsonparse":6}],35:[function(require,module,exports){var extend=require("cog/extend");module.exports=function(switchboard,opts){return require("messenger-ws")(switchboard,extend({endpoints:["/primus","/"]},opts))}},{"cog/extend":4,"messenger-ws":36}],36:[function(require,module,exports){var WebSocket=require("ws");var wsurl=require("wsurl");var ps=require("pull-ws");var defaults=require("cog/defaults");var reTrailingSlash=/\/$/;module.exports=function(url,opts){var timeout=(opts||{}).timeout||1e3;var endpoints=((opts||{}).endpoints||["/"]).map(function(endpoint){return url.replace(reTrailingSlash,"")+endpoint});function connect(callback){var queue=[].concat(endpoints);var receivedData=false;var failTimer;var successTimer;function attemptNext(){var socket;function registerMessage(evt){receivedData=true;(socket.removeEventListener||socket.removeListener)("message",registerMessage)}if(queue.length===0){return callback(new Error("Unable to connect to url: "+url))}socket=new WebSocket(wsurl(queue.shift()));socket.addEventListener("error",handleError);socket.addEventListener("close",handleAbnormalClose);socket.addEventListener("open",function(){var source=ps.source(socket,opts);socket.addEventListener("message",registerMessage);successTimer=setTimeout(function(){clearTimeout(failTimer);callback(null,source,ps.sink(socket,opts))},100)});failTimer=setTimeout(attemptNext,timeout)}function handleAbnormalClose(evt){if(evt.wasClean&&receivedData&&queue.length===0){return}return handleError()}function handleError(){clearTimeout(successTimer);clearTimeout(failTimer);attemptNext()}attemptNext()}return connect}},{"cog/defaults":3,"pull-ws":37,ws:42,wsurl:43}],37:[function(require,module,exports){exports=module.exports=duplex;exports.source=require("./source");exports.sink=require("./sink");function duplex(ws,opts){return{source:exports.source(ws),sink:exports.sink(ws,opts)}}},{"./sink":40,"./source":41}],38:[function(require,module,exports){exports.id=function(item){return item};exports.prop=function(map){if("string"==typeof map){var key=map;return function(data){return data[key]}}return map};exports.tester=function(test){if(!test)return exports.id;if("object"===typeof test&&"function"===typeof test.test)return test.test.bind(test);return exports.prop(test)||exports.id};exports.addPipe=addPipe;function addPipe(read){if("function"!==typeof read)return read;read.pipe=read.pipe||function(reader){if("function"!=typeof reader&&"function"!=typeof reader.sink)throw new Error("must pipe to reader");var pipe=addPipe(reader.sink?reader.sink(read):reader(read));return reader.source||pipe};read.type="Source";return read}var Source=exports.Source=function Source(createRead){function s(){var args=[].slice.call(arguments);return addPipe(createRead.apply(null,args))}s.type="Source";return s};var Through=exports.Through=function(createRead){return function(){var args=[].slice.call(arguments);var piped=[];function reader(read){args.unshift(read);read=createRead.apply(null,args);while(piped.length)read=piped.shift()(read);return read}reader.pipe=function(read){piped.push(read);if(read.type==="Source")throw new Error("cannot pipe "+reader.type+" to Source");reader.type=read.type==="Sink"?"Sink":"Through";return reader};reader.type="Through";return reader}};var Sink=exports.Sink=function Sink(createReader){return function(){var args=[].slice.call(arguments);if(!createReader)throw new Error("must be createReader function");function s(read){args.unshift(read);return createReader.apply(null,args)}s.type="Sink";return s}};exports.maybeSink=exports.maybeDrain=function(createSink,cb){if(!cb)return Through(function(read){var ended;return function(close,cb){if(close)return read(close,cb);if(ended)return cb(ended);createSink(function(err,data){ended=err||true;if(!err)cb(null,data);else cb(ended)})(read)}})();return Sink(function(read){return createSink(cb)(read)})()}},{}],39:[function(require,module,exports){module.exports=function(socket,callback){var remove=socket&&(socket.removeEventListener||socket.removeListener);function cleanup(){if(typeof remove=="function"){remove.call(socket,"open",handleOpen);remove.call(socket,"error",handleErr)}}function handleOpen(evt){cleanup();callback()}function handleErr(evt){cleanup();callback(evt)}if(socket.readyState>=2){return callback(true)}if(socket.readyState===1){return callback()}socket.addEventListener("open",handleOpen);socket.addEventListener("error",handleErr)}},{}],40:[function(require,module,exports){(function(process){var pull=require("pull-core");var ready=require("./ready");module.exports=pull.Sink(function(read,socket,opts){opts=opts||{};var closeOnEnd=opts.closeOnEnd!==false;var onClose="function"===typeof opts?opts:opts.onClose;function next(end,data){if(end){if(closeOnEnd&&socket.readyState<=1){if(onClose)socket.addEventListener("close",function(ev){if(ev.wasClean)onClose();else{var err=new Error("ws error");err.event=ev;onClose(err)}});socket.close()}return}ready(socket,function(end){if(end){return read(end,function(){})}socket.send(data);process.nextTick(function(){read(null,next)})})}read(null,next)})}).call(this,require("_process"))},{"./ready":39,_process:54,"pull-core":38}],41:[function(require,module,exports){var pull=require("pull-core");var ready=require("./ready");module.exports=pull.Source(function(socket){var buffer=[];var receiver;var ended;socket.addEventListener("message",function(evt){if(receiver){return receiver(null,evt.data)}buffer.push(evt.data)});socket.addEventListener("close",function(evt){if(ended)return;if(receiver){return receiver(ended=true)}});socket.addEventListener("error",function(evt){if(ended)return;ended=evt;if(receiver){receiver(ended)}});function read(abort,cb){receiver=null;if(ended)return cb(ended);if(abort){receiver=cb;return socket.close()}ready(socket,function(end){if(end){return cb(ended=end)}if(ended&&ended!==true){return cb(ended)}else if(buffer.length>0){return cb(null,buffer.shift())}else if(ended){return cb(true)}receiver=cb})}return read})},{"./ready":39,"pull-core":38}],42:[function(require,module,exports){var global=function(){return this}();var WebSocket=global.WebSocket||global.MozWebSocket;module.exports=WebSocket?ws:null;function ws(uri,protocols,opts){var instance;if(protocols){instance=new WebSocket(uri,protocols)}else{instance=new WebSocket(uri)}return instance}if(WebSocket)ws.prototype=WebSocket.prototype},{}],43:[function(require,module,exports){var reHttpUrl=/^http(.*)$/;module.exports=function(url,opts){var current=(opts||{}).current||typeof location!="undefined"&&location.href;var currentProtocol=current&&current.slice(0,current.indexOf(":"));var insecure=(opts||{}).insecure;var isRelative=url.slice(0,2)=="//";var forceWS=!currentProtocol||currentProtocol==="file:";if(isRelative){return forceWS?(insecure?"ws:":"wss:")+url:currentProtocol.replace(reHttpUrl,"ws$1")+":"+url}return url.replace(reHttpUrl,"ws$1")}},{}],44:[function(require,module,exports){"use strict";var debug=require("cog/logger")("rtc/cleanup");var CANNOT_CLOSE_STATES=["closed"];var EVENTS_DECOUPLE_BC=["addstream","datachannel","icecandidate","negotiationneeded","removestream","signalingstatechange"];var EVENTS_DECOUPLE_AC=["iceconnectionstatechange"];module.exports=function(pc){var currentState=pc.iceConnectionState;var canClose=CANNOT_CLOSE_STATES.indexOf(currentState)<0;function decouple(events){events.forEach(function(evtName){if(pc["on"+evtName]){pc["on"+evtName]=null}})}decouple(EVENTS_DECOUPLE_BC);if(canClose){debug("attempting connection close, current state: "+pc.iceConnectionState);pc.close()}setTimeout(function(){decouple(EVENTS_DECOUPLE_AC)},100)}},{"cog/logger":7}],45:[function(require,module,exports){"use strict";var mbus=require("mbus");var queue=require("rtc-taskqueue");var cleanup=require("./cleanup");var monitor=require("./monitor");var throttle=require("cog/throttle");var CLOSED_STATES=["closed","failed"];var CHECKING_STATES=["checking"];function couple(pc,targetId,signaller,opts){var debugLabel=(opts||{}).debugLabel||"rtc";var debug=require("cog/logger")(debugLabel+"/couple");var mon=monitor(pc,targetId,signaller,(opts||{}).logger);var emit=mbus("",mon);var reactive=(opts||{}).reactive;var endOfCandidates=true;var disconnectTimeout=(opts||{}).disconnectTimeout||1e4;var disconnectTimer;var isMaster=signaller.isMaster(targetId);var q=queue(pc,opts);var createOrRequestOffer=throttle(function(){if(!isMaster){return signaller.to(targetId).send("/negotiate")}q.createOffer()},100,{leading:false});var debounceOffer=throttle(q.createOffer,100,{leading:false});function decouple(){debug("decoupling "+signaller.id+" from "+targetId);mon.stop();cleanup(pc);signaller.removeListener("sdp",handleSdp);signaller.removeListener("candidate",handleCandidate);signaller.removeListener("negotiate",handleNegotiateRequest);signaller.removeListener("message:sdp",handleSdp);signaller.removeListener("message:candidate",handleCandidate);signaller.removeListener("message:negotiate",handleNegotiateRequest)}function handleCandidate(data){q.addIceCandidate(data)}function handleSdp(sdp,src){emit("sdp.remote",sdp);if(!src||src.id!==targetId){return}q.setRemoteDescription(sdp)}function handleConnectionClose(){debug("captured pc close, iceConnectionState = "+pc.iceConnectionState);decouple()}function handleDisconnect(){debug("captured pc disconnect, monitoring connection status");disconnectTimer=setTimeout(function(){debug("manually closing connection after disconnect timeout");cleanup(pc)},disconnectTimeout);mon.on("statechange",handleDisconnectAbort)}function handleDisconnectAbort(){debug("connection state changed to: "+pc.iceConnectionState);if(CHECKING_STATES.indexOf(pc.iceConnectionState)>=0){return}resetDisconnectTimer();if(CLOSED_STATES.indexOf(pc.iceConnectionState)>=0){return mon("closed")}mon.once("disconnect",handleDisconnect)}function handleLocalCandidate(evt){var data;if(evt.candidate){resetDisconnectTimer();data={candidate:evt.candidate.candidate,sdpMid:evt.candidate.sdpMid,sdpMLineIndex:evt.candidate.sdpMLineIndex};emit("ice.local",data);signaller.to(targetId).send("/candidate",data);endOfCandidates=false}else if(!endOfCandidates){endOfCandidates=true;emit("ice.gathercomplete");signaller.to(targetId).send("/endofcandidates",{})}}function handleNegotiateRequest(src){if(src.id===targetId){emit("negotiate.request",src.id);debounceOffer()}}function resetDisconnectTimer(){mon.off("statechange",handleDisconnectAbort);debug("reset disconnect timer, state: "+pc.iceConnectionState);clearTimeout(disconnectTimer)}if(reactive){pc.onnegotiationneeded=function(){emit("negotiate.renegotiate");createOrRequestOffer()}}pc.onicecandidate=handleLocalCandidate;q.on("sdp.local",function(desc){signaller.to(targetId).send("/sdp",desc)});signaller.on("sdp",handleSdp);signaller.on("candidate",handleCandidate);signaller.on("message:sdp",handleSdp);signaller.on("message:candidate",handleCandidate);if(isMaster){signaller.on("negotiate",handleNegotiateRequest);signaller.on("message:negotiate",handleNegotiateRequest)}mon.once("closed",handleConnectionClose);mon.once("disconnected",handleDisconnect);mon.createOffer=createOrRequestOffer;return mon}module.exports=couple},{"./cleanup":44,"./monitor":49,"cog/logger":7,"cog/throttle":8,mbus:9,"rtc-taskqueue":50}],46:[function(require,module,exports){"use strict";module.exports=require("rtc-core/detect")},{"rtc-core/detect":12}],47:[function(require,module,exports){"use strict";var debug=require("cog/logger")("generators");var detect=require("./detect");var defaults=require("cog/defaults");var mappings={create:{dtls:function(c){if(!detect.moz){c.optional=(c.optional||[]).concat({DtlsSrtpKeyAgreement:true})}}}};exports.config=function(config){var iceServerGenerator=(config||{}).iceServerGenerator;return defaults({},config,{iceServers:typeof iceServerGenerator=="function"?iceServerGenerator():[]})};exports.connectionConstraints=function(flags,constraints){var generated={};var m=mappings.create;var out;Object.keys(flags||{}).forEach(function(key){if(m[key]){m[key](generated)}});out=defaults({},constraints,generated);debug("generated connection constraints: ",out);return out}},{"./detect":46,"cog/defaults":3,"cog/logger":7}],48:[function(require,module,exports){"use strict";var gen=require("./generators");var detect=exports.detect=require("./detect");var findPlugin=require("rtc-core/plugin");exports.logger=require("cog/logger");var RTCPeerConnection=exports.RTCPeerConnection=detect("RTCPeerConnection");exports.couple=require("./couple");exports.createConnection=function(opts,constraints){var plugin=findPlugin((opts||{}).plugins);var PeerConnection=(opts||{}).RTCPeerConnection||RTCPeerConnection;var config=gen.config(opts);constraints=gen.connectionConstraints(opts,constraints);if(plugin&&typeof plugin.createConnection=="function"){return plugin.createConnection(config,constraints)}return new PeerConnection(config,constraints)}},{"./couple":45,"./detect":46,"./generators":47,"cog/logger":7,"rtc-core/plugin":15}],49:[function(require,module,exports){"use strict";var mbus=require("mbus");var stateMappings={completed:"connected"};var peerStateEvents=["signalingstatechange","iceconnectionstatechange"];module.exports=function(pc,targetId,signaller,parentBus){var monitor=mbus("",parentBus);var state;function checkState(){var newState=getMappedState(pc.iceConnectionState);monitor("statechange",pc,newState);if(state!==newState){monitor(newState);state=newState}}function handleClose(){monitor("closed")}pc.onclose=handleClose;peerStateEvents.forEach(function(evtName){pc["on"+evtName]=checkState});monitor.stop=function(){pc.onclose=null;peerStateEvents.forEach(function(evtName){pc["on"+evtName]=null})};monitor.checkState=checkState;if(!pc){return monitor}state=getMappedState(pc.iceConnectionState);return monitor};function getMappedState(state){return stateMappings[state]||state}},{mbus:9}],50:[function(require,module,exports){var detect=require("rtc-core/detect");var findPlugin=require("rtc-core/plugin");
var PriorityQueue=require("priorityqueuejs");var checkCandidate=require("rtc-validator/candidate");var sdpclean=require("rtc-sdpclean");var PRIORITY_LOW=100;var PRIORITY_WAIT=1e3;var DEFAULT_PRIORITIES=["candidate","setLocalDescription","setRemoteDescription","createAnswer","createOffer"];var METHOD_EVENTS={setLocalDescription:"setlocaldesc",setRemoteDescription:"setremotedesc",createOffer:"offer",createAnswer:"answer"};var VALID_RESPONSE_STATES=["have-remote-offer","have-local-pranswer"];module.exports=function(pc,opts){var queue=new PriorityQueue(orderTasks);var tq=require("mbus")("",(opts||{}).logger);var priorities=(opts||{}).priorities||DEFAULT_PRIORITIES;var plugin=findPlugin((opts||{}).plugins);var checkQueueTimer=0;var currentTask;var defaultFail=tq.bind(tq,"fail");var sdpFilter=(opts||{}).sdpfilter||(opts||{}).sdpFilter;var RTCSessionDescription=(opts||{}).RTCSessionDescription||detect("RTCSessionDescription");var RTCIceCandidate=(opts||{}).RTCIceCandidate||detect("RTCIceCandidate");function abortQueue(err){console.error(err)}function applyCandidate(task,next){var data=task.args[0];var candidate=data&&data.candidate&&createIceCandidate(data);function handleOk(){tq("ice.remote.applied",candidate);next()}function handleFail(err){tq("ice.remote.invalid",candidate);next(err)}if(!candidate){return next()}pc.addIceCandidate(candidate,handleOk,handleFail)}function checkQueue(){var next=!queue.isEmpty()&&!currentTask&&queue.peek();var ready=next&&testReady(next);var retry=!queue.isEmpty()&&isNotClosed(pc);checkQueueTimer=0;if(!ready){return retry&&triggerQueueCheck()}currentTask=queue.deq();currentTask.fn(currentTask,function(err){var fail=currentTask.fail||defaultFail;var pass=currentTask.pass;var taskName=currentTask.name;if(err){console.error(taskName+" task failed: ",err);return fail(err)}if(typeof pass=="function"){pass.apply(currentTask,[].slice.call(arguments,1))}setTimeout(function(){currentTask=null;triggerQueueCheck()},0)})}function cleansdp(desc){var sdpErrors=[];var sdp=desc&&sdpclean(desc.sdp,{collector:sdpErrors});if(desc&&sdp!==desc.sdp){console.info("invalid lines removed from sdp: ",sdpErrors);desc.sdp=sdp}if(typeof sdpFilter=="function"){desc.sdp=sdpFilter(desc.sdp,pc)}return desc}function completeConnection(){if(VALID_RESPONSE_STATES.indexOf(pc.signalingState)>=0){return tq.createAnswer()}}function createIceCandidate(data){if(plugin&&typeof plugin.createIceCandidate=="function"){return plugin.createIceCandidate(data)}return new RTCIceCandidate(data)}function createSessionDescription(data){if(plugin&&typeof plugin.createSessionDescription=="function"){return plugin.createSessionDescription(data)}return new RTCSessionDescription(data)}function emitSdp(){tq("sdp.local",this.args[0])}function enqueue(name,handler,opts){return function(){var args=[].slice.call(arguments);if(opts&&typeof opts.processArgs=="function"){args=args.map(opts.processArgs)}queue.enq({args:args,name:name,fn:handler,checks:[isNotClosed].concat((opts||{}).checks||[]),pass:(opts||{}).pass,fail:(opts||{}).fail});triggerQueueCheck()}}function execMethod(task,next){var fn=pc[task.name];var eventName=METHOD_EVENTS[task.name]||(task.name||"").toLowerCase();var cbArgs=[success,fail];var isOffer=task.name==="createOffer";function fail(err){tq.apply(tq,["negotiate.error",task.name,err].concat(task.args));next(err)}function success(){tq.apply(tq,[["negotiate",eventName,"ok"],task.name].concat(task.args));next.apply(null,[null].concat([].slice.call(arguments)))}if(typeof fn!="function"){return next(new Error('cannot call "'+task.name+'" on RTCPeerConnection'))}tq.apply(tq,["negotiate."+eventName].concat(task.args));fn.apply(pc,task.args.concat(cbArgs).concat(isOffer?generateConstraints():[]))}function extractCandidateEventData(data){while(data&&data.candidate&&data.candidate.candidate){data=data.candidate}return data}function generateConstraints(){var allowedKeys={offertoreceivevideo:"OfferToReceiveVideo",offertoreceiveaudio:"OfferToReceiveAudio",icerestart:"IceRestart",voiceactivitydetection:"VoiceActivityDetection"};var constraints={OfferToReceiveVideo:true,OfferToReceiveAudio:true};Object.keys(opts||{}).forEach(function(key){if(allowedKeys[key.toLowerCase()]){constraints[allowedKeys[key.toLowerCase()]]=opts[key]}});return{mandatory:constraints}}function hasLocalOrRemoteDesc(pc,task){return pc.__hasDesc||(pc.__hasDesc=!!pc.remoteDescription)}function isNotNegotiating(pc){return pc.signalingState!=="have-local-offer"}function isNotClosed(pc){return pc.signalingState!=="closed"}function isStable(pc){return pc.signalingState==="stable"}function isValidCandidate(pc,data){return data.__valid||(data.__valid=checkCandidate(data.args[0]).length===0)}function orderTasks(a,b){var tasks=[a,b];var readiness=tasks.map(testReady);var taskPriorities=tasks.map(function(task,idx){var ready=readiness[idx];var priority=ready&&priorities.indexOf(task.name);return ready?priority>=0?priority:PRIORITY_LOW:PRIORITY_WAIT});return taskPriorities[1]-taskPriorities[0]}function testReady(task){return(task.checks||[]).reduce(function(memo,check){return memo&&check(pc,task)},true)}function triggerQueueCheck(){if(checkQueueTimer)return;checkQueueTimer=setTimeout(checkQueue,50)}tq.addIceCandidate=enqueue("addIceCandidate",applyCandidate,{processArgs:extractCandidateEventData,checks:[hasLocalOrRemoteDesc,isValidCandidate]});tq.setLocalDescription=enqueue("setLocalDescription",execMethod,{processArgs:cleansdp,pass:emitSdp});tq.setRemoteDescription=enqueue("setRemoteDescription",execMethod,{processArgs:createSessionDescription,pass:completeConnection});tq.createOffer=enqueue("createOffer",execMethod,{checks:[isNotNegotiating],pass:tq.setLocalDescription});tq.createAnswer=enqueue("createAnswer",execMethod,{pass:tq.setLocalDescription});return tq}},{mbus:9,priorityqueuejs:51,"rtc-core/detect":12,"rtc-core/plugin":15,"rtc-sdpclean":52,"rtc-validator/candidate":53}],51:[function(require,module,exports){module.exports=PriorityQueue;function PriorityQueue(comparator){this._comparator=comparator||PriorityQueue.DEFAULT_COMPARATOR;this._elements=[]}PriorityQueue.DEFAULT_COMPARATOR=function(a,b){if(a instanceof Number&&b instanceof Number){return a-b}else{a=a.toString();b=b.toString();if(a==b)return 0;return a>b?1:-1}};PriorityQueue.prototype.isEmpty=function(){return this.size()===0};PriorityQueue.prototype.peek=function(){if(this.isEmpty())throw new Error("PriorityQueue is empty");return this._elements[0]};PriorityQueue.prototype.deq=function(){var first=this.peek();var last=this._elements.pop();var size=this.size();if(size===0)return first;this._elements[0]=last;var current=0;while(current<size){var largest=current;var left=2*current+1;var right=2*current+2;if(left<size&&this._compare(left,largest)>0){largest=left}if(right<size&&this._compare(right,largest)>0){largest=right}if(largest===current)break;this._swap(largest,current);current=largest}return first};PriorityQueue.prototype.enq=function(element){var size=this._elements.push(element);var current=size-1;while(current>0){var parent=Math.floor((current-1)/2);if(this._compare(current,parent)<0)break;this._swap(parent,current);current=parent}return size};PriorityQueue.prototype.size=function(){return this._elements.length};PriorityQueue.prototype.forEach=function(fn){return this._elements.forEach(fn)};PriorityQueue.prototype._compare=function(a,b){return this._comparator(this._elements[a],this._elements[b])};PriorityQueue.prototype._swap=function(a,b){var aux=this._elements[a];this._elements[a]=this._elements[b];this._elements[b]=aux}},{}],52:[function(require,module,exports){var validators=[[/^(a\=candidate.*)$/,require("rtc-validator/candidate")]];var reSdpLineBreak=/(\r?\n|\\r\\n)/;module.exports=function(input,opts){var lineBreak=detectLineBreak(input);var lines=input.split(lineBreak);var collector=(opts||{}).collector;lines=lines.filter(function(line){var validator=validators.reduce(function(memo,data,idx){return typeof memo!="undefined"?memo:data[0].exec(line)&&{line:line.replace(data[0],"$1"),fn:data[1]}},undefined);var errors=validator?validator.fn(validator.line):[];if(collector){errors.forEach(function(err){collector.push(err)})}return errors.length===0});return lines.join(lineBreak)};function detectLineBreak(input){var match=reSdpLineBreak.exec(input);return match&&match[0]}},{"rtc-validator/candidate":53}],53:[function(require,module,exports){var debug=require("cog/logger")("rtc-validator");var rePrefix=/^(?:a=)?candidate:/;var reIP=/^(\d+\.){3}\d+$/;var partValidation=[[/.+/,"invalid foundation component","foundation"],[/\d+/,"invalid component id","component-id"],[/(UDP|TCP)/i,"transport must be TCP or UDP","transport"],[/\d+/,"numeric priority expected","priority"],[reIP,"invalid connection address","connection-address"],[/\d+/,"invalid connection port","connection-port"],[/typ/,'Expected "typ" identifier',"type classifier"],[/.+/,"Invalid candidate type specified","candidate-type"]];module.exports=function(data){var errors=[];var candidate=data&&(data.candidate||data);var prefixMatch=candidate&&rePrefix.exec(candidate);var parts=prefixMatch&&candidate.slice(prefixMatch[0].length).split(/\s/);if(!candidate){return[new Error("empty candidate")]}if(!prefixMatch){return[new Error("candidate did not match expected sdp line format")]}errors=errors.concat(parts.map(validateParts)).filter(Boolean);return errors};function validateParts(part,idx){var validator=partValidation[idx];if(validator&&!validator[0].test(part)){debug(validator[2]+" part failed validation: "+part);return new Error(validator[1])}}},{"cog/logger":7}],54:[function(require,module,exports){var process=module.exports={};var queue=[];var draining=false;function drainQueue(){if(draining){return}draining=true;var currentQueue;var len=queue.length;while(len){currentQueue=queue;queue=[];var i=-1;while(++i<len){currentQueue[i]()}len=queue.length}draining=false}process.nextTick=function(fun){queue.push(fun);if(!draining){setTimeout(drainQueue,0)}};process.title="browser";process.browser=true;process.env={};process.argv=[];process.version="";function noop(){}process.on=noop;process.addListener=noop;process.once=noop;process.off=noop;process.removeListener=noop;process.removeAllListeners=noop;process.emit=noop;process.binding=function(name){throw new Error("process.binding is not supported")};process.cwd=function(){return"/"};process.chdir=function(dir){throw new Error("process.chdir is not supported")};process.umask=function(){return 0}},{}]},{},[1])(1)});